<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title layout:title-pattern="$CONTENT_TITLE __ $LAYOUT_TITLE">Baralga</title>

    <link rel="stylesheet" href="/webjars/bulma/0.9.1/css/bulma.min.css">
    <link rel="stylesheet" href="/webjars/font-awesome/5.15.1/css/all.min.css">

    <script src="https://unpkg.com/@hotwired/turbo@7.0.0-beta.1/dist/turbo.es5-umd.js" ></script>
    <script defer>
      // Turbo.connectStreamSource(new WebSocket('ws://localhost:8080/messages'))
    </script>

    <script src="/webjars/stimulus/2.0.0/dist/stimulus.umd.js"></script>
    <script src="/webjars/dayjs/1.9.1/dayjs.min.js"></script>

    <script>
    (() => {
      const application = Stimulus.Application.start()

      application.register("tracker", class extends Stimulus.Controller {

        static get targets() {
          return [ "name", "controlStart", "controlStop", "controlSwitchProject", "start", "duration" ]
        }

        updateTimer() {
            let endTime = dayjs();

            let hours = endTime.diff(this.startTime, "h")
            let minutes = endTime.diff(this.startTime, "m")

            this.durationTarget.innerHTML = hours.toString().padStart(2, "0") + ":" + minutes.toString().padStart(2, "0");

            fetch("/activities/ping");
        }

        start() {
            this.startTime = dayjs();

            this.startTarget.innerHTML = this.startTime.format("HH:mm");

            this.controlStartTarget.style.display = "none";
            this.controlStopTarget.style.display = "inline-flex";
            this.controlSwitchProjectTarget.disabled = true;

            this.updateTimer();
            this.updateTimerFunction = setInterval(() => {
              this.updateTimer()
            }, 10000);
        }

        stop() {
            this.endTime = dayjs();

            this.startTarget.innerHTML = "";
            this.durationTarget.innerHTML = "";

            if (this.updateTimerFunction) {
                clearInterval(this.updateTimerFunction);
            }

            this.element.querySelector("input[name='day']").value = this.startTime.format("DD/MM/YYYY");
            this.element.querySelector("input[name='startTime']").value = this.startTime.format("HH:mm");
            this.element.querySelector("input[name='endTime']").value = this.endTime.format("HH:mm");

            this.controlStartTarget.style.display = "inline-flex";
            this.controlStopTarget.style.display = "none";
            this.controlSwitchProjectTarget.disabled = false;

            this.element.requestSubmit();
        }

      })
    })()
  </script>

</head>
<body>

<!-- Main Navigation -->
<nav up-fixed="top" class="navbar is-dark" role="navigation" aria-label="main navigation" layout:fragment="navigation">
    <div class="navbar-brand">
        <a class="navbar-item is-primary" style="font-weight: bold; font-variant: small-caps;" th:href="@{/}">
            Baralga
        </a>

        <!--
        <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        -->
    </div>

    <div id="navbarBasicExample" class="navbar-menu">
        <div class="navbar-start">
            <a th:href="@{/}" class="navbar-item">
                Home
            </a>
            <a th:href="@{/projects}" class="navbar-item">
                Projects
            </a>
        </div>

        <div class="navbar-end">
            <a class="navbar-item" sec:authorize="isAuthenticated()" sec:authentication="name">
            </a>
            <div class="navbar-item">
                <div class="buttons">
                    <form th:action="@{/logout}" method="POST" up-target="body">
                        <input type="submit" class="button is-light" value="Logout"></input>
                    </form>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Content Section -->
<section class="section">
    <div class="container" id="b__content" layout:fragment="content">
        <h1 class="title">
            Hello Baralga!
        </h1>
    </div>
</section>

<!-- Footer -->

</body>
</html>
